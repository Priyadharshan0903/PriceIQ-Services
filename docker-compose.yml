version: '3.8'

services:
  # MongoDB for Auth Service
  mongo-auth:
    image: mongo:7.0
    container_name: mongo-auth
    restart: always
    environment:
      MONGO_INITDB_DATABASE: auth_db
    ports:
      - "27017:27017"
    volumes:
      - mongo-auth-data:/data/db
    networks:
      - bestbuy-network

  # MongoDB for Product Service
  mongo-product:
    image: mongo:7.0
    container_name: mongo-product
    restart: always
    environment:
      MONGO_INITDB_DATABASE: product_db
    ports:
      - "27018:27017"
    volumes:
      - mongo-product-data:/data/db
    networks:
      - bestbuy-network

  # MongoDB for Review Service
  mongo-review:
    image: mongo:7.0
    container_name: mongo-review
    restart: always
    environment:
      MONGO_INITDB_DATABASE: review_db
    ports:
      - "27019:27017"
    volumes:
      - mongo-review-data:/data/db
    networks:
      - bestbuy-network

  # MongoDB for Comparison Service
  mongo-comparison:
    image: mongo:7.0
    container_name: mongo-comparison
    restart: always
    environment:
      MONGO_INITDB_DATABASE: comparison_db
    ports:
      - "27020:27017"
    volumes:
      - mongo-comparison-data:/data/db
    networks:
      - bestbuy-network

  # MongoDB for Cart Service
  mongo-cart:
    image: mongo:7.0
    container_name: mongo-cart
    restart: always
    environment:
      MONGO_INITDB_DATABASE: cart_db
    ports:
      - "27021:27017"
    volumes:
      - mongo-cart-data:/data/db
    networks:
      - bestbuy-network

  # MongoDB for Order Service
  mongo-order:
    image: mongo:7.0
    container_name: mongo-order
    restart: always
    environment:
      MONGO_INITDB_DATABASE: order_db
    ports:
      - "27022:27017"
    volumes:
      - mongo-order-data:/data/db
    networks:
      - bestbuy-network

  # MongoDB for User Service
  mongo-user:
    image: mongo:7.0
    container_name: mongo-user
    restart: always
    environment:
      MONGO_INITDB_DATABASE: user_db
    ports:
      - "27023:27017"
    volumes:
      - mongo-user-data:/data/db
    networks:
      - bestbuy-network

  # Redis for caching
  redis:
    image: redis:7-alpine
    container_name: redis-cache
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - bestbuy-network

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - AUTH_SERVICE_URL=http://auth-service:3001
      - PRODUCT_SERVICE_URL=http://product-service:3002
      - REVIEW_SERVICE_URL=http://review-service:3003
      - COMPARISON_SERVICE_URL=http://comparison-service:3004
      - CART_SERVICE_URL=http://cart-service:3005
      - ORDER_SERVICE_URL=http://order-service:3006
      - USER_SERVICE_URL=http://user-service:3007
    depends_on:
      - auth-service
      - product-service
      - review-service
      - comparison-service
      - cart-service
      - order-service
      - user-service
    networks:
      - bestbuy-network

  # Auth Service
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    restart: always
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - MONGODB_URI=mongodb://mongo-auth:27017/auth_db
      - JWT_SECRET=your-super-secret-jwt-key-change-in-production
      - JWT_EXPIRES_IN=15m
      - REFRESH_TOKEN_EXPIRES_IN=7d
    depends_on:
      - mongo-auth
    networks:
      - bestbuy-network
    volumes:
      - ./auth-service:/app
      - /app/node_modules

  # Product Service
  product-service:
    build:
      context: ./product-service
      dockerfile: Dockerfile
    container_name: product-service
    restart: always
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - PORT=3002
      - MONGODB_URI=mongodb://mongo-product:27017/product_db
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mongo-product
      - redis
    networks:
      - bestbuy-network
    volumes:
      - ./product-service:/app
      - /app/node_modules

  # Review Service
  review-service:
    build:
      context: ./review-service
      dockerfile: Dockerfile
    container_name: review-service
    restart: always
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - PORT=3003
      - MONGODB_URI=mongodb://mongo-review:27017/review_db
    depends_on:
      - mongo-review
    networks:
      - bestbuy-network
    volumes:
      - ./review-service:/app
      - /app/node_modules

  # Comparison Service
  comparison-service:
    build:
      context: ./comparison-service
      dockerfile: Dockerfile
    container_name: comparison-service
    restart: always
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=development
      - PORT=3004
      - MONGODB_URI=mongodb://mongo-comparison:27017/comparison_db
      - PRODUCT_SERVICE_URL=http://product-service:3002
      - REVIEW_SERVICE_URL=http://review-service:3003
    depends_on:
      - mongo-comparison
      - product-service
      - review-service
    networks:
      - bestbuy-network
    volumes:
      - ./comparison-service:/app
      - /app/node_modules

  # Cart Service
  cart-service:
    build:
      context: ./cart-service
      dockerfile: Dockerfile
    container_name: cart-service
    restart: always
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=development
      - PORT=3005
      - MONGODB_URI=mongodb://mongo-cart:27017/cart_db
      - PRODUCT_SERVICE_URL=http://product-service:3002
    depends_on:
      - mongo-cart
      - product-service
    networks:
      - bestbuy-network
    volumes:
      - ./cart-service:/app
      - /app/node_modules

  # Order Service
  order-service:
    build:
      context: ./order-service
      dockerfile: Dockerfile
    container_name: order-service
    restart: always
    ports:
      - "3006:3006"
    environment:
      - NODE_ENV=development
      - PORT=3006
      - MONGODB_URI=mongodb://mongo-order:27017/order_db
      - CART_SERVICE_URL=http://cart-service:3005
      - PRODUCT_SERVICE_URL=http://product-service:3002
    depends_on:
      - mongo-order
      - cart-service
      - product-service
    networks:
      - bestbuy-network
    volumes:
      - ./order-service:/app
      - /app/node_modules

  # User Service
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    restart: always
    ports:
      - "3007:3007"
    environment:
      - NODE_ENV=development
      - PORT=3007
      - MONGODB_URI=mongodb://mongo-user:27017/user_db
    depends_on:
      - mongo-user
    networks:
      - bestbuy-network
    volumes:
      - ./user-service:/app
      - /app/node_modules

networks:
  bestbuy-network:
    driver: bridge

volumes:
  mongo-auth-data:
  mongo-product-data:
  mongo-review-data:
  mongo-comparison-data:
  mongo-cart-data:
  mongo-order-data:
  mongo-user-data:
  redis-data:
